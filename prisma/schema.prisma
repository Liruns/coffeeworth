// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// User (크리에이터 & 후원자)
// ==========================================
model User {
  id String @id @default(cuid())

  // 인증 정보
  email         String    @unique
  emailVerified DateTime?

  // 프로필 정보
  name     String? // 표시 이름
  username String? @unique // URL용 (예: @username)
  image    String? // 프로필 이미지 URL
  bio      String? @db.VarChar(500) // 자기소개

  // 소셜 링크 (JSON)
  socialLinks Json? // { github: "...", blog: "..." }

  // 후원 설정
  coffeePrice Int    @default(3000) // 커피 1잔 가격 (원)
  themeColor  String @default("#FFDD00") // 테마 색상

  // 계좌 정보 (정산용)
  bankCode    String? // 은행 코드
  bankAccount String? // 계좌번호
  bankHolder  String? // 예금주

  // 설정
  isPublic    Boolean @default(true) // 페이지 공개 여부
  emailNotify Boolean @default(true) // 이메일 알림 여부
  isVerified  Boolean @default(false) // 계좌 인증 여부

  // 관계
  accounts Account[]
  sessions Session[]
  supports Support[] @relation("CreatorSupports") // 받은 후원
  given    Support[] @relation("SupporterSupports") // 한 후원
  payouts  Payout[]

  // 타임스탬프
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([username])
  @@index([email])
}

// ==========================================
// NextAuth 관련 테이블
// ==========================================
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==========================================
// Support (후원)
// ==========================================
model Support {
  id String @id @default(cuid())

  // 크리에이터 (후원 받는 사람)
  creatorId String
  creator   User   @relation("CreatorSupports", fields: [creatorId], references: [id])

  // 후원자 (회원일 경우)
  supporterId String?
  supporter   User?   @relation("SupporterSupports", fields: [supporterId], references: [id])

  // 후원자 정보 (비회원 또는 익명)
  supporterName  String? // 표시할 이름
  supporterEmail String? // 이메일 (영수증 발송용)
  isAnonymous    Boolean @default(false) // 익명 여부

  // 후원 내용
  coffeeCount Int // 커피 개수
  unitPrice   Int // 커피 1잔 가격 (후원 시점)
  amount      Int // 총 후원 금액
  message     String? @db.VarChar(200) // 응원 메시지

  // 결제 정보
  orderId       String  @unique // 주문 ID (우리 시스템)
  paymentKey    String? @unique // 토스페이먼츠 결제 키
  paymentMethod String? // 결제 수단 (kakao, toss, card)

  // 상태
  status SupportStatus @default(PENDING)

  // 수수료 (정산 시 계산)
  platformFee Int? // 플랫폼 수수료
  pgFee       Int? // PG 수수료
  netAmount   Int? // 실 정산액

  // 정산 연결
  payoutId String?
  payout   Payout? @relation(fields: [payoutId], references: [id])

  // 타임스탬프
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  paidAt    DateTime? // 결제 완료 시각

  @@index([creatorId])
  @@index([supporterId])
  @@index([status])
  @@index([createdAt])
  @@index([payoutId])
}

enum SupportStatus {
  PENDING // 결제 대기
  COMPLETED // 결제 완료
  FAILED // 결제 실패
  REFUNDED // 환불됨
}

// ==========================================
// Payout (정산)
// ==========================================
model Payout {
  id String @id @default(cuid())

  // 크리에이터
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // 정산 금액
  totalAmount Int // 총 후원액
  platformFee Int // 플랫폼 수수료 합계
  pgFee       Int // PG 수수료 합계
  netAmount   Int // 실 정산액

  // 계좌 정보 (정산 시점 스냅샷)
  bankCode    String
  bankAccount String
  bankHolder  String

  // 상태
  status PayoutStatus @default(PENDING)

  // 포함된 후원
  supports     Support[]
  supportCount Int // 후원 건수

  // 처리 정보
  processedAt DateTime? // 처리 시각
  failReason  String? // 실패 사유

  // 타임스탬프
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum PayoutStatus {
  PENDING // 정산 대기
  PROCESSING // 처리 중
  COMPLETED // 완료
  FAILED // 실패
}
